<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.worksout.mapper.goods.GoodsMapper">

    <!-- ADMIN QUERY -->
    <select id="getGoodsList" resultType="goods">
        SELECT /* getGoodsList */
               DISTINCT
               (SELECT DISTINCT MAIN_IMG FROM GOODS_INFO WHERE GOODS_NO = info.GOODS_NO AND COLOR = info.REP_COLOR) AS MAIN_IMG
               , (SELECT CATEGORY_NM FROM GOODS_CATEGORY WHERE CATEGORY_NO = info.CATEGORY_NO) AS CATEGORY_NM
               , GOODS_NO
               , GOODS_NM
               , REP_COLOR
               , SEASON
               , SUPPLY_PRICE
               , RETAIL_PRICE
          FROM
               GOODS_INFO info
      ORDER BY REG_DT DESC
               LIMIT 0, 10
    </select>

    <select id="getConditionalGoodsList" resultType="goods">
        SELECT /* getConditionalGoodsList */
               DISTINCT
               (SELECT DISTINCT MAIN_IMG FROM GOODS_INFO WHERE GOODS_NO = info.GOODS_NO AND COLOR = info.REP_COLOR) AS MAIN_IMG
               , (SELECT CATEGORY_NM FROM GOODS_CATEGORY WHERE CATEGORY_NO = info.CATEGORY_NO) AS CATEGORY_NM
               , GOODS_NO
               , GOODS_NM
               , REP_COLOR
               , SEASON
               , SUPPLY_PRICE
               , RETAIL_PRICE
          FROM
               GOODS_INFO info
          <include refid="goodsFilter" />
      ORDER BY REG_DT DESC
    </select>
    <sql id="goodsFilter">
        <if test="_parameter == null">ORDER BY REG_DT DESC LIMIT 0, 10</if>
        <where>
            <if test="seasonNm != null and seasonNm != ''">AND SEASON = #{seasonNm}</if>
            <if test="categoryNo != null and categoryNo != 0">AND CATEGORY_NO = #{categoryNo}</if>
            <if test="searchGb != null and searchGb != '' and searchTxt != null and searchTxt != ''">
                AND UPPER(${searchGb}) like CONCAT(CONCAT('%',UPPER(#{searchTxt})),'%')
            </if>
            <if test="minPrice != null and minPrice != 0">AND RETAIL_PRICE <![CDATA[>]]> #{minPrice}</if>
            <if test="maxPrice != null and maxPrice != 0">AND RETAIL_PRICE <![CDATA[<]]> #{maxPrice}</if>
            <if test="sizeGroupNo != null and sizeGroupNo != 0">AND SIZE_GROUP_NO = #{sizeGroupNo}</if>
            <if test="displayYn != null">AND DISPLAY_YN = #{displayYn}</if>
        </where>
    </sql>

    <insert id="registerGoods">
        INSERT INTO GOODS_INFO
                    (
                    CATEGORY_NO
                    , SEASON
                    , GOODS_NO
                    , GOODS_NM
                    , COLOR
                    , REP_COLOR
                    , COLOR_ORD
                    , SIZE_GROUP_NO
                    , GOODS_DESC
                    , SUPPLY_PRICE
                    , RETAIL_PRICE
                    , REGR
                    , REG_DT
                    )
             VALUES
                    <foreach collection="list" item="goods" separator=",">
                        (
                        #{goods.categoryNo}
                        , #{goods.season}
                        , #{goods.goodsNo}
                        , #{goods.goodsNm}
                        , #{goods.color}
                        , #{goods.repColor}
                        , #{goods.colorOrd}
                        , #{goods.sizeGroupNo}
                        , #{goods.goodsDesc}
                        , #{goods.supplyPrice}
                        , #{goods.retailPrice}
                        , #{goods.regr}
                        , NOW()
                        )
                    </foreach>
    </insert>
    
    <!-- SHOP QUERY -->
    <resultMap id="goodsListShop" type="Goods">
        <id column="GOODS_NO" property="goodsNo" />
        <result column="GOODS_NM" property="goodsNm" />
        <result column="CATEGORY_NO" property="categoryNo" />
        <result column="SEASON" property="season" />
        <result column="REP_COLOR" property="repColor" />
        <result column="RETAIL_PRICE" property="retailPrice" />
        <result column="REP_IMG" property="repImg" />
        <collection property="colors" ofType="String">
            <result column="COLOR" property="colors" />
        </collection>
        <collection property="mainImgs" ofType="String">
            <result column="MAIN_IMG" property="mainImgs" />
        </collection>
    </resultMap>
    <select id="getGoodsListShop" resultMap="goodsListShop">
        SELECT DISTINCT /* getGoodsListShop */
	           CATEGORY_NO
	           , SEASON
	           , GOODS_NO
	           , GOODS_NM
	           , REP_COLOR
	           , COLOR
	           , RETAIL_PRICE
	           , COLOR_ORD
	           , CATEGORY_ORD
	           , MAIN_ORD
	           , DISPLAY_YN
	           , MAIN_IMG
	           , (SELECT DISTINCT MAIN_IMG FROM GOODS_INFO WHERE GOODS_NO = info.GOODS_NO AND COLOR = info.REP_COLOR) AS REP_IMG
	           , STOCK
          FROM GOODS_INFO info
         WHERE DISPLAY_YN = true
      ORDER BY MAIN_ORD, COLOR_ORD
    </select>

</mapper>